---
import type { GetStaticPaths } from 'astro';
import { Icon } from 'astro-icon/components';

import CommonLayout from '../../../layout/CommonLayout.astro';
import PageLayout from '../../../layout/PageLayout.astro';
import PageTitle from '../../../components/PageTitle.astro';

import { ThumbnailGallery } from './_internal/components/ThumbnailGallery/ThumbnailGallery';
import WorkDescriptions from './_internal/components/WorkDescriptions.astro';

import type { Work } from '../../../context/work/types';

import { root, backButton } from './_index.css';
import { getCollection, render } from 'astro:content';
import { collectionToWork } from '../../../context/work/services';
import { processImageForThumbnailGallery } from './_internal/components/ThumbnailGallery/image';
import type { RenderResult } from 'astro:content';

export const getStaticPaths = (async () => {
	const worksCollectionEntries = await getCollection('works');
	return await Promise.all(
		worksCollectionEntries.map(async (entry) => {
			const work = collectionToWork(entry);
			return {
				params: { id: work.id },
				props: { rendered: await render(entry), work },
			};
		}),
	);
}) satisfies GetStaticPaths;

interface Props {
	rendered: RenderResult;
	work: Work;
}

const { rendered, work } = Astro.props;

const galleryProps = await processImageForThumbnailGallery(work);
---

<CommonLayout>
	<PageTitle title="works" />
	<PageLayout class={root}>
		<ThumbnailGallery client:load {...galleryProps} />
		<WorkDescriptions {work} {rendered} />
		<a href="/works" class={backButton} id="back">
			<Icon name="back-arrow" width={32} height={6} />
			<span>back</span>
		</a>
	</PageLayout>
</CommonLayout>

<script>
	const backButton = document.getElementById('back');
	if (backButton == null || !(backButton instanceof HTMLAnchorElement)) {
		throw new Error('The element #back was not found');
	}

	if (document.referrer.startsWith(document.location.origin)) {
		// 同サイトから来ていそうな場合は、history.back() で前ページに戻る
		backButton.href = 'javascript:history.back()';
	}
</script>
