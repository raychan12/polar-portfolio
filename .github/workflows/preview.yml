name: Deploy Preview

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-slim
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: ./.github/actions/setup
      - name: Initialize comment
        run: |
          cat > comment.txt <<EOF
          ### <span aria-hidden="true">ğŸš§</span> Deploy Preview building...

          |  Name | Link |
          |---------------------------------|------------------------|
          |<span aria-hidden="true">ğŸ”¨</span> Latest commit | ${{ github.sha }} |
          |<span aria-hidden="true">ğŸ”</span> Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |
          ---
          EOF

          gh pr comment ${{ github.event.number }} --body-file comment.txt --edit-last --create-if-none
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build project
        run: pnpm build
        env:
          ADOBE_PROJECT_ID: ${{ secrets.ADOBE_PROJECT_ID }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_WORKS_DATABASE_ID: ${{ secrets.NOTION_WORKS_DATABASE_ID }}
      - name: Calc short sha
        id: calc
        run: |
          short_sha=$(git rev-parse --short ${{ github.sha }})
          echo "COMMIT_SHORT_SHA=$short_sha" >> $GITHUB_OUTPUT
      - name: Deploy preview version to Cloudflare Workers
        id: deploy_preview
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: versions upload --tag ${{ steps.calc.outputs.COMMIT_SHORT_SHA }} --message "Preview deployment for ${{ github.head_ref }}"
      - name: Update comment with deployment link
        run: |
          cat > comment.txt <<EOF
          ### <span aria-hidden="true">âœ…</span> Deploy Preview ready!

          |  Name | Link |
          |---------------------------------|------------------------|
          |<span aria-hidden="true">ğŸ”¨</span> Latest commit | ${{ github.sha }} |
          |<span aria-hidden="true">ğŸ”</span> Latest deploy log | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |
          |<span aria-hidden="true">ğŸŒ</span> Preview link | [${{ steps.deploy_preview.outputs.deployment-url }}](${{ steps.deploy_preview.outputs.deployment-url }}) |
          ---
          EOF

          gh pr comment ${{ github.event.number }} --body-file comment.txt --edit-last --create-if-none
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
